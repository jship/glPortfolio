'use strict';var ShipGL=ShipGL||{};ShipGL.GLResource=function(a){this.gl=a};ShipGL.FileLoader=function(){function a(a){return function(c,d){var e=new XMLHttpRequest;e.open("GET",c,!1);d&&e.overrideMimeType(d);e.send(null);return e.status==a?e.responseText:null}}return{loadLocal:a(0),loadHttp:a(200)}}();ShipGL.Math=function(){function a(a){return a*Math.PI/180}return{toDegrees:function(a){return 180*a/Math.PI},toRadians:a,isPowerOf2:function(a){return 0==(a&a-1)},nextHighestPowerOf2:function(a){--a;for(var c=1;32>c;c<<=1)a|=a>>c;return a+1},makeClamp:function(a,c){return function(d){return Math.min(Math.max(d,a),c)}},lerp:function(a,c,d){return a+(c-a)*d},sphericalToCartesian:function(b,c,d){d=d||1;b=a(b);c=a(c);return[d*Math.cos(c)*Math.sin(b),d*Math.sin(c)*Math.sin(b),d*Math.cos(b)]},arbitraryRotation:function(a,
c,d,e){mat4.identity(e);return mat4.translate(mat4.rotate(mat4.translate(e,c),a,d),[-c[0],-c[1],-c[2]])}}}();ShipGL.Camera=function(a,b,c){this.viewMatrix=mat4.create();this._scratchVec=vec3.create();vec3.direction(a,b,this._scratchVec);this.position=vec3.create(a);this.direction=vec4.create();vec3.negate(this._scratchVec,this.direction);this.right=vec4.create();vec3.cross(c,this._scratchVec,this.right);vec3.normalize(this.right);this.up=vec4.create();vec3.cross(this._scratchVec,this.right,this.up);vec3.normalize(this.up);this.moveSpeed=5;this.lookSpeed=ShipGL.Math.toRadians(3);this._leftRotMat=mat4.create();
this._rightRotMat=mat4.create();this._update();this._updateRotationStuff()};ShipGL.Camera.prototype.setPosition=function(a){vec3.set(a,this.position);this._update()};ShipGL.Camera.prototype.setMoveSpeed=function(a){this.moveSpeed=Math.abs(a)};ShipGL.Camera.prototype.setLookSpeed=function(a){this.lookSpeed=Math.abs(a);this._updateRotationStuff()};
ShipGL.Camera.prototype._update=function(){vec3.scale(this.direction,this.moveSpeed,this._scratchVec);vec3.add(this.position,this._scratchVec,this._scratchVec);mat4.lookAt(this.position,this._scratchVec,this.up,this.viewMatrix)};ShipGL.Camera.prototype._updateRotationStuff=function(){mat4.identity(this._leftRotMat);mat4.identity(this._rightRotMat);mat4.rotate(this._leftRotMat,this.lookSpeed,this.up);mat4.rotate(this._rightRotMat,-this.lookSpeed,this.up)};
ShipGL.Camera.prototype.moveForward=function(){vec3.scale(this.direction,this.moveSpeed,this._scratchVec);vec3.add(this.position,this._scratchVec);this._update()};ShipGL.Camera.prototype.moveBackward=function(){vec3.scale(this.direction,this.moveSpeed,this._scratchVec);vec3.subtract(this.position,this._scratchVec);this._update()};ShipGL.Camera.prototype.moveLeft=function(){vec3.scale(this.right,this.moveSpeed,this._scratchVec);vec3.subtract(this.position,this._scratchVec);this._update()};
ShipGL.Camera.prototype.moveRight=function(){vec3.scale(this.right,this.moveSpeed,this._scratchVec);vec3.add(this.position,this._scratchVec);this._update()};ShipGL.Camera.prototype.moveUp=function(){vec3.scale(this.up,this.moveSpeed,this._scratchVec);vec3.add(this.position,this._scratchVec);this._update()};ShipGL.Camera.prototype.moveDown=function(){vec3.scale(this.up,this.moveSpeed,this._scratchVec);vec3.subtract(this.position,this._scratchVec);this._update()};
ShipGL.Camera.prototype.lookLeft=function(){mat4.multiplyVec4(this._leftRotMat,this.direction);vec3.normalize(this.direction);vec3.cross(this.direction,this.up,this.right);vec3.normalize(this.right);this._update()};ShipGL.Camera.prototype.lookRight=function(){mat4.multiplyVec4(this._rightRotMat,this.direction);vec3.normalize(this.direction);vec3.cross(this.direction,this.up,this.right);vec3.normalize(this.right);this._update()};ShipGL.Buffer=function(a,b,c){ShipGL.GLResource.call(this,a);this.rawBuffer=this.gl.createBuffer();this.BufferType=b;this.ArrayType=c;this.bytesPerElement=this.ArrayType.BYTES_PER_ELEMENT;this.byteCount=this.length=0};ShipGL.Buffer.unbindAll=function(a){a.bindBuffer(a.ARRAY_BUFFER,null);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null)};ShipGL.Buffer.prototype=Object.create(ShipGL.GLResource.prototype);ShipGL.Buffer.prototype.bind=function(){this.gl.bindBuffer(this.BufferType,this.rawBuffer)};
ShipGL.Buffer.prototype.unbind=function(){this.gl.bindBuffer(this.BufferType,null)};ShipGL.Buffer.prototype.allocate=function(a,b){b=b||this.gl.STATIC_DRAW;this.length=a;this.byteCount=this.bytesPerElement*this.length;this.gl.bufferData(this.BufferType,this.byteCount,b)};ShipGL.Buffer.prototype.write=function(a,b){this.gl.bufferSubData(this.BufferType,(b||0)*this.bytesPerElement,new this.ArrayType(a))};ShipGL.Buffer.prototype.deallocate=function(){this.gl.deleteBuffer(this.rawBuffer)};ShipGL.BufferUtilities=function(a){ShipGL.GLResource.call(this,a);this.createVertexBuffer=this.makeBufferCreator(this.gl.ARRAY_BUFFER,Float32Array);this.createIndexBuffer=this.makeBufferCreator(this.gl.ELEMENT_ARRAY_BUFFER,Uint16Array)};ShipGL.BufferUtilities.prototype=Object.create(ShipGL.GLResource.prototype);ShipGL.BufferUtilities.prototype.makeBufferCreator=function(a,b){return function(c,d){var d=d||c.length,e=new ShipGL.Buffer(this.gl,a,b);e.bind();e.allocate(d);e.write(c);e.unbind();return e}};ShipGL.ShaderProgram=function(a){ShipGL.GLResource.call(this,a);this.rawProgram=this.gl.createProgram();this._bpf=Float32Array.BYTES_PER_ELEMENT;this._bps=Uint16Array.BYTES_PER_ELEMENT};ShipGL.ShaderProgram.prototype=Object.create(ShipGL.GLResource.prototype);ShipGL.ShaderProgram.prototype.bind=function(){this.gl.useProgram(this.rawProgram)};ShipGL.ShaderProgram.prototype.unbind=function(){this.gl.useProgram(null)};
ShipGL.ShaderProgram.prototype.create=function(a,b){var c=this.createShader(this.gl.VERTEX_SHADER,a),d=this.createShader(this.gl.FRAGMENT_SHADER,b);this.gl.attachShader(this.rawProgram,c);this.gl.attachShader(this.rawProgram,d);this.gl.linkProgram(this.rawProgram);if(!this.gl.getProgramParameter(this.rawProgram,this.gl.LINK_STATUS))return alert("GLSL LINK ERROR!\n"+this.gl.getProgramInfoLog(this.rawProgram)),null};
ShipGL.ShaderProgram.prototype.createShader=function(a,b){var c=this.gl.createShader(a);this.gl.shaderSource(c,b);this.gl.compileShader(c);return!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)?(alert("GLSL COMPILE ERROR!\n"+b+"\n"+this.gl.getShaderInfoLog(c)),null):c};ShipGL.ShaderProgram.prototype.attributeLocation=function(a){var b=this.gl.getAttribLocation(this.rawProgram,a);0>b&&alert("ShipGL.ShaderProgram.attributeLocation: "+a+" is not a valid uniform! Returning null...");return b};
ShipGL.ShaderProgram.prototype.uniformLocation=function(a){var b=this.gl.getUniformLocation(this.rawProgram,a);0>b&&alert("ShipGL.ShaderProgram.uniformLocation: "+a+" is not a valid uniform! Returning null...");return b};ShipGL.ShaderProgram.prototype.enableAttributeArray=function(a){this[a]=this[a]||this.attributeLocation(a);this.gl.enableVertexAttribArray(this[a])};ShipGL.ShaderProgram.prototype.disableAttributeArray=function(a){this[a]=this[a]||this.attributeLocation(a);this.gl.disableVertexAttribArray(this[a])};
ShipGL.ShaderProgram.prototype.setAttributeBuffer1f=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],1,this.gl.FLOAT,d,this._bpf*b,this._bpf*c)};ShipGL.ShaderProgram.prototype.setAttributeBuffer2f=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],2,this.gl.FLOAT,d,this._bpf*b,this._bpf*c)};
ShipGL.ShaderProgram.prototype.setAttributeBuffer3f=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],3,this.gl.FLOAT,d,this._bpf*b,this._bpf*c)};ShipGL.ShaderProgram.prototype.setAttributeBuffer4f=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],4,this.gl.FLOAT,d,this._bpf*b,this._bpf*c)};
ShipGL.ShaderProgram.prototype.setAttributeBuffer1i=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],1,this.gl.INT,d,this._bps*b,this._bps*c)};ShipGL.ShaderProgram.prototype.setAttributeBuffer2i=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],2,this.gl.INT,d,this._bps*b,this._bps*c)};
ShipGL.ShaderProgram.prototype.setAttributeBuffer3i=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],3,this.gl.INT,d,this._bps*b,this._bps*c)};ShipGL.ShaderProgram.prototype.setAttributeBuffer4i=function(a,b,c,d){d=d||!1;this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttribPointer(this[a],4,this.gl.INT,d,this._bps*b,this._bps*c)};
ShipGL.ShaderProgram.prototype.setAttributeValue1f=function(a,b){this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttrib1f(this[a],b)};ShipGL.ShaderProgram.prototype.setAttributeValue2f=function(a,b,c){this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttrib2f(this[a],b,c)};ShipGL.ShaderProgram.prototype.setAttributeValue3f=function(a,b,c,d){this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttrib3f(this[a],b,c,d)};
ShipGL.ShaderProgram.prototype.setAttributeValue4f=function(a,b,c,d,e){this[a]=this[a]||this.attributeLocation(a);this.gl.vertexAttrib4f(this[a],b,c,d,e)};ShipGL.ShaderProgram.prototype.setUniform1f=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform1f(this[a],b)};ShipGL.ShaderProgram.prototype.setUniform2f=function(a,b,c){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform2f(this[a],b,c)};
ShipGL.ShaderProgram.prototype.setUniform3f=function(a,b,c,d){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform3f(this[a],b,c,d)};ShipGL.ShaderProgram.prototype.setUniform4f=function(a,b,c,d,e){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform4f(this[a],b,c,d,e)};ShipGL.ShaderProgram.prototype.setUniform1i=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform1i(this[a],b)};
ShipGL.ShaderProgram.prototype.setUniform2i=function(a,b,c){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform2i(this[a],b,c)};ShipGL.ShaderProgram.prototype.setUniform3i=function(a,b,c,d){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform3i(this[a],b,c,d)};ShipGL.ShaderProgram.prototype.setUniform4i=function(a,b,c,d,e){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform4i(this[a],b,c,d,e)};
ShipGL.ShaderProgram.prototype.setUniformVec1f=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform1fv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformVec2f=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform2fv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformVec3f=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform3fv(this[a],b)};
ShipGL.ShaderProgram.prototype.setUniformVec4f=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform4fv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformVec1i=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform1iv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformVec2i=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform2iv(this[a],b)};
ShipGL.ShaderProgram.prototype.setUniformVec3i=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform3iv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformVec4i=function(a,b){this[a]=this[a]||this.uniformLocation(a);this.gl.uniform4iv(this[a],b)};ShipGL.ShaderProgram.prototype.setUniformMat2=function(a,b,c){c=c||!1;this[a]=this[a]||this.uniformLocation(a);this.gl.uniformMatrix2fv(this[a],c,b)};
ShipGL.ShaderProgram.prototype.setUniformMat3=function(a,b,c){c=c||!1;this[a]=this[a]||this.uniformLocation(a);this.gl.uniformMatrix3fv(this[a],c,b)};ShipGL.ShaderProgram.prototype.setUniformMat4=function(a,b,c){c=c||!1;this[a]=this[a]||this.uniformLocation(a);this.gl.uniformMatrix4fv(this[a],c,b)};ShipGL.Texture=function(a){ShipGL.GLResource.call(this,a);this.textureType=this.gl.TEXTURE_2D;this.rawTexture=this.gl.createTexture();this.isLoaded=!1;this.height=this.width=0;this.NPOT=!0;var b=this;this._image=new Image;this._image.onload=function(){b.onImageLoad()}};ShipGL.Texture.unbindAll=function(a){a.bindTexture(a.TEXTURE_2D,null);a.bindTexture(a.TEXTURE_CUBE_MAP,null)};ShipGL.Texture.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.Texture.prototype.bind=function(a){0<=a&&this.gl.activeTexture(this.gl.TEXTURE0+a);this.gl.bindTexture(this.textureType,this.rawTexture)};ShipGL.Texture.prototype.unbind=function(){this.gl.bindTexture(this.textureType,null)};ShipGL.Texture.prototype.load=function(a){this._image.src=a};ShipGL.Texture.prototype.setRepeatS=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_WRAP_S,a?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE)};
ShipGL.Texture.prototype.setRepeatT=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_WRAP_T,a?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE)};ShipGL.Texture.prototype.setSmooth=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_MAG_FILTER,a?this.gl.LINEAR:this.gl.NEAREST);var b=this.NPOT?this.gl.LINEAR:this.gl.LINEAR_MIPMAP_LINEAR;this.gl.texParameteri(this.textureType,this.gl.TEXTURE_MIN_FILTER,a?b:this.gl.NEAREST)};
ShipGL.Texture.prototype.onImageLoad=function(){this.bind();this.width=this._image.width;this.height=this._image.height;this.NPOT=!(ShipGL.Math.isPowerOf2(this._image.width)&&ShipGL.Math.isPowerOf2(this._image.height));var a=!this.NPOT;this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,1);this.gl.texImage2D(this.textureType,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this._image);this.setRepeatS(a);this.setRepeatT(a);this.setSmooth(!0);a&&this.gl.generateMipmap(this.textureType);this.unbind();
this.isLoaded=!0;delete this._image};ShipGL.CubeTexture=function(a){ShipGL.GLResource.call(this,a);this.textureType=this.gl.TEXTURE_CUBE_MAP;this.rawTexture=this.gl.createTexture();this._images=[];for(var b=this,a=0;6>a;a++)this._images[a]=new Image,this._images[a].onload=function(a){return function(){b.onImageLoad(a)}}(a),this._images[a].onerror=function(a){return function(){alert("Image "+a+" "+this.src+" load error!")}}(a)};ShipGL.CubeTexture.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.CubeTexture.prototype.bind=function(a){0<=a&&this.gl.activeTexture(this.gl.TEXTURE0+a);this.gl.bindTexture(this.textureType,this.rawTexture)};ShipGL.CubeTexture.prototype.unbind=function(){this.gl.bindTexture(this.textureType,null)};ShipGL.CubeTexture.prototype.loadPositiveX=function(a){this._images[0].src=a};ShipGL.CubeTexture.prototype.loadNegativeX=function(a){this._images[1].src=a};ShipGL.CubeTexture.prototype.loadPositiveY=function(a){this._images[2].src=a};
ShipGL.CubeTexture.prototype.loadNegativeY=function(a){this._images[3].src=a};ShipGL.CubeTexture.prototype.loadPositiveZ=function(a){this._images[4].src=a};ShipGL.CubeTexture.prototype.loadNegativeZ=function(a){this._images[5].src=a};ShipGL.CubeTexture.prototype.setRepeatS=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_WRAP_S,a?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE)};
ShipGL.CubeTexture.prototype.setRepeatT=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_WRAP_T,a?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE)};ShipGL.CubeTexture.prototype.setSmooth=function(a){this.gl.texParameteri(this.textureType,this.gl.TEXTURE_MAG_FILTER,a?this.gl.LINEAR:this.gl.NEAREST);this.gl.texParameteri(this.textureType,this.gl.TEXTURE_MIN_FILTER,a?this.gl.LINEAR:this.gl.NEAREST)};
ShipGL.CubeTexture.prototype.onImageLoad=function(a){this.bind();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,0);this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this._images[a]);this.setRepeatS(!1);this.setRepeatT(!1);this.setSmooth(!0);this.unbind()};ShipGL.Light=function(a){this.intensity=vec3.create(a);this.isRotating=!1;this.rotationMat=mat4.create()};ShipGL.Light.prototype.update=function(){throw"ShipGL.Light.update is abstract!";};ShipGL.Light.prototype.startRotation=function(){throw"ShipGL.Light.startRotation is abstract!";};ShipGL.Light.prototype.stopRotation=function(){throw"ShipGL.Light.stopRotation is abstract!";};ShipGL.PointLight=function(a,b){ShipGL.Light.call(this,a);this.position=vec4.createFrom(b[0],b[1],b[2],1)};ShipGL.PointLight.prototype=Object.create(ShipGL.Light.prototype);ShipGL.PointLight.prototype.update=function(){this.isRotating&&(mat4.multiplyVec4(this.rotationMat,this.position),this.position[3]=1)};ShipGL.PointLight.prototype.startRotation=function(a,b,c){this.isRotating=!0;ShipGL.Math.arbitraryRotation(ShipGL.Math.toRadians(a),c,b,this.rotationMat)};
ShipGL.PointLight.prototype.stopRotation=function(){this.isRotating=!1};ShipGL.DirectionalLight=function(a,b){ShipGL.Light.call(this,a);this.direction=vec4.createFrom(b[0],b[1],b[2],0);vec3.normalize(this.direction)};ShipGL.DirectionalLight.prototype=Object.create(ShipGL.Light.prototype);ShipGL.DirectionalLight.prototype.update=function(){this.isRotating&&(mat4.multiplyVec4(this.rotationMat,this.direction),this.direction[3]=0,vec3.normalize(this.direction))};
ShipGL.DirectionalLight.prototype.startRotation=function(a,b){this.isRotating=!0;mat4.identity(this.rotationMat);mat4.rotate(this.rotationMat,ShipGL.Math.toRadians(a),b)};ShipGL.DirectionalLight.prototype.stopRotation=function(){this.isRotating=!1};ShipGL.Model=function(a,b){ShipGL.GLResource.call(this,a);var c=ShipGL.FileLoader.loadLocal(b,"application/json")||ShipGL.FileLoader.loadHttp(b,"application/json");this.json=JSON.parse(c);this.vbo=new ShipGL.Buffer(a,a.ARRAY_BUFFER,Float32Array);this.ibo=new ShipGL.Buffer(a,a.ELEMENT_ARRAY_BUFFER,Uint16Array);this.min=vec3.create();this.max=vec3.create();this.center=vec3.create();this.diagonal=0;this._imageDirHelper=b.replace("model.json","")};ShipGL.Model.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.Model.prototype.initialize=function(){this._initBuffers();this._initMaterialTextures();this._initNormalMatrices();this._computeExtents()};ShipGL.Model.prototype.draw=function(){throw"ShipGL.Model.draw is abstract!";};
ShipGL.Model.prototype._initBuffers=function(){var a,b,c,d=0,e=0,f=0;for(a=0;a<this.json.meshes.length;a++)b=this.json.meshes[a],f=0,d+=b.vertexPositions.length,f+=3,d+=b.vertexNormals.length,f+=3,b.hasTexture=!1,b.vertexTexCoordinates&&(b.vertexTexCoordinates[0]&&0<b.vertexTexCoordinates[0].length)&&(c=this.json.materials[b.materialIndex],b.hasTexture=0<c.diffuseTexture.length,b.hasTexture&&(d+=b.vertexTexCoordinates[0].length,f+=2)),b.stride=f,b.hasIndices=!1,b.indices&&0<b.indices.length&&(b.hasIndices=
!0,b.indicesOffset=e,b.indicesByteOffset=Uint16Array.BYTES_PER_ELEMENT*e,e+=b.indices.length);this.vbo.bind();this.ibo.bind();this.vbo.allocate(d);this.ibo.allocate(e);for(a=e=0;a<this.json.meshes.length;a++){b=this.json.meshes[a];b.positionsOffset=e;b.normalsOffset=3+e;b.hasTexture&&(b.texCoordsOffset=6+e);for(d=c=0;c<b.vertexPositions.length;c+=3)this.vbo.write(b.vertexPositions.slice(c,c+3),e),e+=3,this.vbo.write(b.vertexNormals.slice(c,c+3),e),e+=3,b.hasTexture&&(this.vbo.write(b.vertexTexCoordinates[0].slice(d,
d+2),e),e+=2,d+=2);b.hasIndices&&this.ibo.write(b.indices,b.indicesOffset)}this.vbo.unbind();this.ibo.unbind()};ShipGL.Model.prototype._initMaterialTextures=function(){var a,b;for(a=0;a<this.json.materials.length;a++)b=this.json.materials[a],0<b.diffuseTexture.length&&(b.texture=new ShipGL.Texture(this.gl),b.texture.load(this._imageDirHelper+b.diffuseTexture[0]))};
ShipGL.Model.prototype._initNormalMatrices=function(){var a,b;for(a=0;a<this.json.nodes.length;a++)b=this.json.nodes[a],b.normalMatrix=mat4.create(),mat4.inverse(b.modelMatrix,b.normalMatrix),mat4.transpose(b.normalMatrix)};
ShipGL.Model.prototype._computeExtents=function(){function a(a){return function(b,c,d){var e=c[0],f=c[1],g=c[2];a(b[0],c[0])&&(e=b[0]);a(b[1],c[1])&&(f=b[1]);a(b[2],c[2])&&(g=b[2]);d[0]=e;d[1]=f;d[2]=g}}var b=a(function(a,b){return a<b}),c=a(function(a,b){return a>b}),d=vec3.createFrom(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e=vec3.createFrom(-Number.MIN_VALUE,-Number.MIN_VALUE,-Number.MIN_VALUE),f=vec3.create(),i,j,g,k,h;for(i=0;i<this.json.nodes.length;i++){k=this.json.nodes[i];for(j=
0;j<k.meshIndices.length;j++){h=this.json.meshes[k.meshIndices[j]].vertexPositions;for(g=0;g<h.length;g+=3)f[0]=h[g],f[1]=h[g+1],f[2]=h[g+2],mat4.multiplyVec3(k.modelMatrix,f),b(d,f,d),c(e,f,e)}}b=vec3.create();vec3.add(d,e,b);vec3.scale(b,0.5);vec3.set(d,this.min);vec3.set(e,this.max);vec3.set(b,this.center);this.diagonal=vec3.dist(this.min,this.max)};ShipGL.SkyBox=function(a){ShipGL.GLResource.call(this,a);this.cubeMap=new ShipGL.CubeTexture(this.gl);a=new ShipGL.BufferUtilities(this.gl);this.vbo=a.createVertexBuffer([-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1]);this.ibo=a.createIndexBuffer([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);this.program=new ShipGL.ShaderProgram(this.gl);
this.program.create("uniform mat4 uProjMat;\nuniform mat4 uViewMat;\nuniform mat4 uModelMat;\n\nattribute vec3 aPosition;\n\nvarying vec3 texCoord;\n\nvoid main()\n{\n    gl_Position = uProjMat * uViewMat * uModelMat * vec4(aPosition, 1.0);\n    texCoord = aPosition;\n}","precision mediump float;\n\nuniform samplerCube uCubeTex;\n\nvarying vec3 texCoord;\n\nvoid main()\n{\n\tgl_FragColor = textureCube(uCubeTex, texCoord);\n}");this.center=vec3.create();this.width=2;this.projMat=mat4.create();this.viewMat=
mat4.create();this.modelMat=mat4.create()};ShipGL.SkyBox.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.SkyBox.prototype.draw=function(){this.program.bind();this.vbo.bind();this.ibo.bind();this.cubeMap.bind(0);this.program.enableAttributeArray("aPosition");this.program.setUniformMat4("uProjMat",this.projMat);this.program.setUniformMat4("uViewMat",this.viewMat);this.program.setUniformMat4("uModelMat",this.modelMat);this.program.setUniform1i("uCubeTex",0);this.program.setAttributeBuffer3f("aPosition",0,0);this.gl.drawElements(this.gl.TRIANGLES,this.ibo.length,this.gl.UNSIGNED_SHORT,0);this.program.disableAttributeArray("aPosition");
this.cubeMap.unbind();this.ibo.unbind();this.vbo.unbind();this.program.unbind()};ShipGL.SkyBox.prototype.setDirectory=function(a,b){this.cubeMap.loadPositiveX(a+"/positive_x"+b);this.cubeMap.loadPositiveY(a+"/positive_y"+b);this.cubeMap.loadPositiveZ(a+"/positive_z"+b);this.cubeMap.loadNegativeX(a+"/negative_x"+b);this.cubeMap.loadNegativeY(a+"/negative_y"+b);this.cubeMap.loadNegativeZ(a+"/negative_z"+b)};ShipGL.SkyBox.prototype.setCenter=function(a){vec3.set(a,this.center);this._computeModelMatrix()};
ShipGL.SkyBox.prototype.setWidth=function(a){this.width=a;this._computeModelMatrix()};ShipGL.SkyBox.prototype.setProjection=function(a){mat4.set(a,this.projMat)};ShipGL.SkyBox.prototype.setView=function(a){mat4.set(a,this.viewMat)};ShipGL.SkyBox.prototype._computeModelMatrix=function(){var a=0.5*this.width;mat4.identity(this.modelMat);mat4.translate(this.modelMat,this.center);mat4.scale(this.modelMat,[a,a,a])};ShipGL.Floor=function(a){ShipGL.GLResource.call(this,a);this.tilesAcross=10;this.width=2;this.tileTexture=new ShipGL.Texture(this.gl);this.center=vec3.create();a=new ShipGL.BufferUtilities(this.gl);this.vbo=a.createVertexBuffer([-1,0,-1,-1,0,1,1,0,1,1,0,-1,0,0,0,1,1,0,1,1]);this.positionsOffset=0;this.texCoordsOffset=12;this.stride=0;this.ibo=a.createIndexBuffer([0,1,2,0,2,3]);this.program=new ShipGL.ShaderProgram(this.gl);this.program.create("uniform mat4 uProjMat;\nuniform mat4 uViewMat;\nuniform mat4 uModelMat;\nuniform float uTilesAcross;\n\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 texCoord;\n\nvoid main()\n{\n    gl_Position = uProjMat * uViewMat * uModelMat * vec4(aPosition, 1.0);\n    texCoord = uTilesAcross * aTexCoord;\n}",
"precision mediump float;\n\nuniform sampler2D uTex;\n\nvarying vec2 texCoord;\n\nvoid main()\n{\n\tgl_FragColor = texture2D(uTex, texCoord);\n\t//gl_FragColor = vec4(0.8, 0.8, 0.3, 1.0);\n}");this.projMat=mat4.create();this.viewMat=mat4.create();this.modelMat=mat4.create()};ShipGL.Floor.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.Floor.prototype.draw=function(){this.program.bind();this.vbo.bind();this.ibo.bind();this.tileTexture.bind(0);this.program.enableAttributeArray("aPosition");this.program.enableAttributeArray("aTexCoord");this.program.setUniformMat4("uProjMat",this.projMat);this.program.setUniformMat4("uViewMat",this.viewMat);this.program.setUniformMat4("uModelMat",this.modelMat);this.program.setUniform1f("uTilesAcross",this.tilesAcross);this.program.setUniform1i("uTex",0);this.program.setAttributeBuffer3f("aPosition",
this.stride,this.positionsOffset);this.program.setAttributeBuffer2f("aTexCoord",this.stride,this.texCoordsOffset);this.gl.drawElements(this.gl.TRIANGLES,this.ibo.length,this.gl.UNSIGNED_SHORT,0);this.program.disableAttributeArray("aTexCoord");this.program.disableAttributeArray("aPosition");this.tileTexture.unbind();this.ibo.unbind();this.vbo.unbind();this.program.unbind()};ShipGL.Floor.prototype.setTexture=function(a){this.tileTexture.load(a)};
ShipGL.Floor.prototype.setCenter=function(a){vec3.set(a,this.center);this._computeModelMatrix()};ShipGL.Floor.prototype.setWidth=function(a){this.width=a;this._computeModelMatrix()};ShipGL.Floor.prototype.setProjection=function(a){mat4.set(a,this.projMat)};ShipGL.Floor.prototype.setView=function(a){mat4.set(a,this.viewMat)};
ShipGL.Floor.prototype._computeModelMatrix=function(){var a=0.5*this.width;mat4.identity(this.modelMat);mat4.translate(this.modelMat,this.center);mat4.scale(this.modelMat,[a,a,a])};ShipGL.BaseApp=function(a,b){this.canvas=document.getElementById(a);ShipGL.GLResource.call(this,this.createContext(this.canvas,b));this.bufferUtils=new ShipGL.BufferUtilities(this.gl);this.heldKeys=[];this._timeDelta=this._previousTime=this._currentTime=0};ShipGL.BaseApp.prototype=Object.create(ShipGL.GLResource.prototype);
ShipGL.BaseApp.prototype.run=function(){this._previousTime=this._currentTime;this._currentTime=(new Date).getTime();this._timeDelta=this._currentTime-this._previousTime;this.update(this._timeDelta);this.draw(this._timeDelta);var a=this;requestAnimFrame(function(){a.run()})};ShipGL.BaseApp.prototype.createContext=function(a,b){var c=WebGLUtils.setupWebGL(a,b);if(c)return c;alert("Unable to initialize WebGL. Your browser may not support it.")};
ShipGL.BaseApp.prototype.initialize=function(){throw"ShipGL.BaseApp.initialize is abstract!";};ShipGL.BaseApp.prototype.update=function(){throw"ShipGL.BaseApp.update is abstract!";};ShipGL.BaseApp.prototype.draw=function(){throw"ShipGL.BaseApp.draw is abstract!";};ShipGL.BaseApp.prototype.handleHeldKeys=function(){throw"ShipGL.BaseApp.handleHeldKeys is abstract!";};ShipGL.BaseApp.prototype.handleKeyPressed=function(a){this.heldKeys[a]=!0};
ShipGL.BaseApp.prototype.handleKeyReleased=function(a){this.heldKeys[a]=!1};
